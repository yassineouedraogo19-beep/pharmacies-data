<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Pharmacies de Ouagadougou</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>

  <style>
    body, html { margin:0; padding:0; height:100%; font-family:"Segoe UI", Roboto, sans-serif; }
    header {
      background: linear-gradient(90deg,#2c3e50,#34495e);
      color:white; text-align:center; padding:12px; font-size:1.2em; font-weight:bold;
    }
    #container { display:flex; height:calc(100% - 60px); }
    #sidebar {
      width:320px; background:#fff; overflow-y:auto; padding:15px;
      border-right:1px solid #ddd; box-shadow:2px 0 8px rgba(0,0,0,0.05);
    }
    #map { flex:1; }
    .pharmacy {
      background:#fdfdfd; margin-bottom:12px; padding:10px; border-radius:10px;
      box-shadow:0 2px 6px rgba(0,0,0,0.1);
    }
    .pharmacy h3 { margin:0 0 6px; font-size:1em; }
    .pharmacy p { margin:2px 0; font-size:0.85em; }
    .garde { color:green; font-weight:bold; }
    .nongarde { color:#888; }
    .pharmacy button {
      background:#3498db; color:white; border:none; padding:5px 10px;
      border-radius:20px; cursor:pointer; font-size:0.8em;
    }
    .pharmacy button:hover { background:#2980b9; }
    /* Adaptation mobile/tablette */
    @media (max-width:768px) {
      #container { flex-direction:column; }
      #sidebar { width:100%; height:200px; border-right:none; border-bottom:1px solid #ddd; }
      #map { flex:1; height:calc(100% - 200px); }
    }
  </style>
</head>
<body>
  <header>üíä Pharmacies de Ouagadougou</header>
  <div id="container">
    <div id="sidebar">
      <h2>Liste des pharmacies</h2>
      <div id="list"></div>
    </div>
    <div id="map"></div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <script>
    // Groupes de garde (rotation hebdomadaire officielle)
    const groupes = {
      "I": ["Pharmacie Avenir","Pharmacie Archange","Pharmacie Bang-Poore","Pharmacie Baowendsom","Pharmacie Barkwende","Pharmacie Beatitude","Pharmacie Benaia","Pharmacie Bonheur","Pharmacie Camille","Pharmacie Du Centre","Pharmacie Crystal","Pharmacie Des Apotres","Pharmacie Desa","Pharmacie Diaby","Pharmacie Dominique Kabore","Pharmacie El Wanogo","Pharmacie Elite","Pharmacie Guuduma","Pharmacie Hosanna","Pharmacie Jobert"],
      "II": ["Pharmacie Adadoa","Pharmacie Aeroport","Pharmacie Agora","Pharmacie Amaro","Pharmacie Amina","Pharmacie Ar Rahma","Pharmacie Augustine","Pharmacie Bao Neere","Pharmacie Danouma","Pharmacie Boulmiougou","Pharmacie Cathedrale","Pharmacie Cite An 3","Pharmacie Dapoya","Pharmacie Delwende","Pharmacie Denisa","Pharmacie Faso","Pharmacie Flayiri","Pharmacie Hamdalaye","Pharmacie Hanniel","Pharmacie Hope"],
      "III": ["Pharmacie Arzouma","Pharmacie Aimevo","Pharmacie Ave Maria","Pharmacie Balkuy","Pharmacie Baraka","Pharmacie Belle ville","Pharmacie Blessing","Pharmacie carrefour","Pharmacie coura","Pharmacie Djabal","Pharmacie Djimbia","Pharmacie Dunia","Pharmacie Fabere","Pharmacie Galiam","Pharmacie Georgette","Pharmacie Hamamickely","Pharmacie Charis"],
      "IV": ["Pharmacie 1200","Pharmacie Adama","Pharmacie Afiya","Pharmacie Amitie Miyougou","Pharmacie Angele","Pharmacie Bassinko","Pharmacie Bedjou","Pharmacie Bethania","Pharmacie Choukroullah","Pharmacie Circulaire Sede"," Pharmacie De lalliance","Pharmacie De Hippodrome","Pharmacie Diawara","Pharmacie El Shaddai","Pharmacie Espoir","Pharmacie Fraternite","Pharmacie Gare","Pharmacie Gemme","Pharmacie Hambila","Pharmacie Hamid"]
    };

    // Toutes les pharmacies avec coordonn√©es
    const pharmacies = [
      {name:"Pharmacie de la Paix", coords:[12.378422771475776, -1.5233600170264758], phone:"+226 25 30 12 34", address:""},
      {name:"Pharmacie Sainte V√©ronique", coords:[12.32783350245309, -1.6325353891826342], phone:"+226 63 26 04 04", address:"Zagtouli"},
      {name:"Pharmacie Koumajer", coords:[12.371689680363744, -1.5196388468538056], phone:"+226 25 40 20 20", address:"Palais de Justice"},
      {name:"Pharmacie Danouma", coords:[12.283207188144399, -1.5638835593656455], phone:"+226 25 39 55 54", address:"Bonheur Ville"},
      {name:"Pharmacie Adadoa", coords:[12.33401487449051, -1.5621175352140715], phone:"+226 25 33 22 11", address:"Pissy"},
      {name:"Pharmacie La Roche", coords:[12.399480085365385, -1.5841691379141092], phone:"+226 25 39 51 32", address:"Tampouy"},
      {name:"Pharmacie Arzouma", coords:[12.332226757349348, -1.5746491198702215], phone:"+226 25 39 36 99", address:"pissy"},
      {name:"Pharmacie Ave Maria", coords:[12.323745665155746, -1.4693834621984558], phone:"+226 25 48 01 53", address:"karpala"},
      {name:"Pharmacie Balkuy", coords:[12.309753367118667, -1.482244318018904], phone:"+226 25 37 51 36", address:"Balkuy"},
      {name:"Pharmacie Baraka", coords:[12.373572843512981, -1.5388844971187678], phone:"+226 25 33 02 72", address:""},
        {name:"Pharmacie Belle ville", coords:[12.307779399211057, -1.5578469198706708], phone:"+226 25 40 84 14", address:"Route Komsilga"},
        {name:"Pharmacie Blessing", coords:[12.282382171792092, -1.5787461882016476], phone:"+226 01 75 99 75", address:"Rond Point Transition"},
        {name:"Pharmacie Coura", coords:[12.327603061605917, -1.5193038045264606], phone:"+226 25 38 83 90", address:""},
        {name:"Pharmacie Djabal", coords:[12.367934784864035, -1.530990519869615], phone:"+226 25 30 05 76", address:"Kamsonghin"},
        {name:"Pharmacie Djimbia", coords:[12.401653669461254, -1.5143246035316253], phone:"+226 78 83 62 74", address:"tanghin"},
        {name:"Pharmacie Dunia", coords:[12.359433470918159, -1.495252575689979], phone:"+226 25 36 20 51", address:"1200 logement"},
        {name:"Pharmacie Carrefour", coords:[12.367955744551693, -1.5310012487056261], phone:"+226 25 33 23 10", address:"Face 2 Octobre"},
        {name:"Pharmacie Fabere", coords:[12.39748608379908, -1.5551879063769876], phone:"+226 25 41 05 75", address:""},
        {name:"Pharmacie Galiam", coords:[12.399794773534692, -1.5662420333612328], phone:"+226 25 65 31 65", address:"Tampouy"},
        {name:"Pharmacie Hamamickely", coords:[12.4182743340139, -1.5043995180170284], phone:"+226 73 78 32 99", address:"Somgande"},
        {name:"Pharmacie Avenir", coords:[12.375379581118933, -1.4939054603458524], phone:"+226 25 65 10 71", address:"Rue Boassa"},
        {name:"Pharmacie Archange", coords:[12.331842857490432, -1.5845644421644312], phone:"+226 79 20 01 83", address:""},
        {name:"Pharmacie Bang-Poore", coords:[12.423009561663825, -1.5400172333608055], phone:"+226 25 47 96 86", address:"Tanghin"},
        {name:"Pharmacie Baowendsom", coords:[12.403709646647659, -1.577542501851723], phone:"+226 25 41 44 99", address:"Tampouy"},
        {name:"Pharmacie Barwende", coords:[12.374340355296715, -1.6084700910335716], phone:"+226 25 40 85 90", address:"Riemkieta"},
        {name:"Pharmacie Beatitude", coords:[12.307482292868851, -1.5284081910347111], phone:"+226 25 37 47 11", address:"Ouaga 2000"},
        {name:"Pharmacie Benaia", coords:[12.350047271285707, -1.4792546180182218], phone:"+226 25 37 28 30", address:"Katre Yaar"},
        {name:"Pharmacie Bonheur", coords:[12.314236755905183, -1.5552338198705467], phone:"+226 63 73 81 81", address:"Bonheur Ville"},
        {name:"Pharmacie Camille", coords:[12.376112553090445, -1.4789161352133136], phone:"+226 61 80 14 77", address:"AV Charles De Gaulle"},
        {name:"Pharmacie Du Centre", coords:[12.370519898094267, -1.5244548082291782], phone:"+226 25 31 16 60", address:"AV de la nation collee a telecel siege"},
        {name:"Pharmacie Crystal", coords:[12.419895665285893, -1.5586163468529781], phone:"+226 60 46 08 08", address:""},
        {name:"Pharmacie Des Apotres", coords:[12.327433839499927, -1.512536891034369], phone:"+226 25 38 03 82", address:"Non loin de notre dame des Apotre"},
        {name:"Pharmacie Desa", coords:[12.391683560275972, -1.524436533361332], phone:"+226 25 47 50 50", address:"Tanghin"},
        {name:"Pharmacie Diaby", coords:[12.365514846707564, -1.5170299082292695], phone:"+226 25 33 50 00", address:"Koulouba"},
        {name:"Pharmacie Dominique Kabore", coords:[12.330135871076065, -1.5263169603466564], phone:"+226 25 38 48 84", address:"200m Rond point patte doie"},
        {name:"Pharmacie El Wanogo", coords:[12.39893035298728, -1.463648135212948], phone:"+226 25 40 70 22", address:"Wayalghin"},
        {name:"Pharmacie Elite", coords:[12.396821769891291, -1.609798191033208], phone:"+226 25 41 91 77", address:"AV Yennenga"},
        {name:"Pharmacie Hosanna", coords:[12.403069127266578, -1.438149435212898], phone:"+226 25 41 26 48", address:"Face Lycee Naba Yemde"},
        {name:"Pharmacie Jobert", coords:[12.324388746161596, -1.5562033621984415], phone:"+226 25 45 51 75", address:"Pissy Face Chateau"},
        {name:"Pharmacie 1200", coords:[12.366961086749768, -1.4939693352134815], phone:"+226 25 36 02 52", address:"Face St Camille"},
                            {name:"Pharmacie Adama", coords:[12.3356475124779, -1.568265019870173], phone:"+226 62 33 77 77",address:"Pissy"},
                            {name:"Pharmacie Afiya", coords:[12.355552452024083, -1.468631704526019], phone:"+226 66 11 73 65", address:"Zone 1"},
                                {name:"Pharmacie Amitie Miyougou", coords:[12.334777049096013, -1.5351864891825393], phone:"+226 25 38 52 36", address:"Paaglayiri"},
                                {name:"Pharmacie Angele", coords:[12.389978767261168, -1.5629038151733676], phone:"+226 25 35 07 17", address:"Face Monument des MARTYRS"},
                                {name:"Pharmacie Bassinko", coords:[12.39129690825655, -1.6336494180175107], phone:"+226 25 41 71 50", address:"Bssinko"},
                                {name:"Pharmacie Bedjou", coords:[12.344528391696134, -1.4799870170304483], phone:"+226 25 47 58 25", address:"Sanyiri"},
                                {name:"Pharmacie Bethania", coords:[12.364375847696603, -1.5337053333618198], phone:"+226 25 31 31 41", address:"AV Oumarou KANAZOE"},
                                {name:"Pharmacie Choukroula", coords:[12.286850582150091, -1.5382163198710277], phone:"+226 25 40 93 76", address:"Nagrin"},
                                {name:"Pharmacie Circulaire Sede", coords:[12.332776275581534, -1.516230804526379], phone:"+226 25 47 61 27", address:"Ouaga inter"},
                                {name:"Pharmacie De Lalliance", coords:[12.385518503922434, -1.6028846910333734], phone:"+226 66 06 35 39", address:"Rimkieta"},
                                {name:"Pharmacie Hippodrome", coords:[12.375872298953675, -1.557634335213357], phone:"+226 25 34 02 32", address:"Nonsin"},
                                {name:"Pharmacie Diawara", coords:[12.319048742237012, -1.532665104526626], phone:"+226 25 30 61 68", address:"Grand marche"},
                                {name:"Pharmacie El Shaddai", coords:[12.414748003144297, -1.4634754198688058], phone:"+226 25 41 00 02", address:"Benogo"},
                                {name:"Pharmacie Espoir", coords:[12.372733862372058, -1.5457629468537875], phone:"+226 25 31 54 12", address:"Larle"},
                                {name:"Pharmacie Fraternite", coords:[12.391049039841032, -1.4765822775411477], phone:"+226 25 36 48 00", address:"100m de ENAR"},
                                {name:"Pharmacie Gemme", coords:[12.405574367958495, -1.5600065621970325], phone:"+226 62 70 50 50", address:"Tampouy"},
                                {name:"Pharmacie Adadoa", coords:[12.333962468470935, -1.562106806378095], phone:"+226 63 88 39 39", address:"Pissy"},
                                {name:"Pharmacie Aeroport", coords:[12.350688579248413, -1.521305404526087], phone:"+226 25 31 42 22", address:"Aeroport"},
                                {name:"Pharmacie Agora", coords:[12.371178901152, -1.5211614333616907], phone:"+226 25 84 47 49", address:"Rood Wooko"},
                                {name:"Pharmacie Amaro", coords:[12.36131225101878, -1.5398363045259154], phone:"+226 25 34 33 28", address:"Goughin"},
                                {name:"Pharmacie Amina", coords:[12.369773164275266, -1.4839639315099995], phone:"+226 25 36 76 65", address:""},
                                {name:"Pharmacie Ar Rahma", coords:[12.389569682759118, -1.5739295198692589], phone:"+226 25 35 09 86", address:"Tampouy"},
                                {name:"Pharmacie Augustine", coords:[12.325744692524115, -1.5032014928861048], phone:"+226 25 37 61 00", address:"Ouaga 2000"},
                                {name:"Pharmacie Bao Neere", coords:[12.373963322756127, -1.5859933161660646], phone:"+226 25 45 88 88", address:"Rimkieta"},
                                {name:"Pharmacie Danouma", coords:[12.283196735924825, -1.563904991035144], phone:"+226 25 39 55 54", address:"Pissy"},
                                {name:"Pharmacie Boulmiougou", coords:[12.335088218381275, -1.5795712910342405], phone:"+226 25 43 12 68", address:"AV Cathedrale"},
                                {name:"Pharmacie Cathedrale", coords:[12.364074348083655, -1.5242087891820146], phone:"+226 25 31 28 07", address:"Larle"},
                                {name:"Pharmacie Cite An 3", coords:[12.405501019621644, -1.5599636468531908], phone:"+226 25 33 19 66", address:"Bonheur ville"},
                                {name:"Pharmacie Dapoya", coords:[12.380135802547128, -1.5240005323701458], phone:"+226 25 31 32 01", address:"Dapoya"},
                                {name:"Pharmacie Delwende", coords:[12.401214672170788, -1.472102073837544], phone:"+226 25 36 72 80", address:"Kossodo"},
                                {name:"Pharmacie Denisa", coords:[12.253770560539913, -1.5290696487075388], phone:"+226 71 82 76 60", address:"Komsilga"},
                                {name:"Pharmacie Faso", coords:[12.322364581908971, -1.5280184151813179], phone:"+226 25 38 19 29", address:"Patte Doie"},
                                {name:"Pharmacie Flayiri", coords:[12.337065787923029, -1.5080626621982203], phone:"+226 25 40 73 44", address:"ZAD"},
                                {name:"Pharmacie Hamdalaye", coords:[12.375417821996, -1.551419948705491], phone:"+226 25 34 36 94", address:"Hamdalaye"},
                                {name:"Pharmacie Hanniel", coords:[12.379898450305982, -1.4524616305184324], phone:"+226 25 36 60 20", address:"Balkuy"},
                                {name:"Pharmacie Hope", coords:[12.405785532754377, -1.43227781986894], phone:"+226 71 14 22 22", address:"saaba"},
                                {name:"Pharmacie Charis", coords:[12.329925447732005, -1.6149816584949848], phone:"+226 25 43 90 91", address:""},
                                   


    ];

    // D√©terminer le groupe de garde selon la semaine
   function getGroupeDeGarde(date = new Date()) {
  const reference = new Date("2025-12-20"); // d√©but du groupe III
  const diffDays = Math.floor((date - reference) / 86400000);
  const diffWeeks = Math.floor(diffDays / 7);

  const rotation = ["III", "IV", "I", "II"]; // ordre officiel
  return rotation[diffWeeks % rotation.length];
}


    // Initialiser la carte blanche
    const map = L.map('map').setView([12.3714, -1.5197], 13);
   L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> &copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd',
    maxZoom: 19
    }).addTo(map);
     
 // Pharmacie de garde (cercle vert avec croix blanche)
const gardeIcon = L.divIcon({
  html: `
    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40">
      <circle cx="20" cy="20" r="18" fill="#27ae60" stroke="white" stroke-width="3"/>
      <line x1="20" y1="8" x2="20" y2="32" stroke="white" stroke-width="4"/>
      <line x1="8" y1="20" x2="32" y2="20" stroke="white" stroke-width="4"/>
    </svg>
  `,
  className: '',
  iconSize: [40, 40],
  iconAnchor: [20, 40]
});



// Pharmacie non de garde (cercle gris avec pilule bleue)
const nonGardeIcon = L.divIcon({
  html: `
    <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36">
      <circle cx="18" cy="18" r="16" fill="#bdc3c7" stroke="white" stroke-width="2"/>
      <rect x="10" y="14" width="16" height="8" rx="4" fill="#2980b9"/>
    </svg>
  `,
  className: '',
  iconSize: [36, 36],
  iconAnchor: [18, 36]
});



// Ic√¥ne utilisateur : pointeur goutte bleu
const userIcon = L.divIcon({
  html: `
    <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36">
      <path d="M18 2 C26 2 32 8 32 16 C32 26 18 34 18 34 C18 34 4 26 4 16 C4 8 10 2 18 2Z" 
            fill="#2980b9" stroke="#1b4f72" stroke-width="2"/>
      <circle cx="18" cy="16" r="6" fill="white"/>
    </svg>
  `,
  className: '',
  iconSize: [36, 36],
  iconAnchor: [18, 34]
});
let userLat, userLng, userMarker2;

navigator.geolocation.getCurrentPosition(pos => {
  userLat = pos.coords.latitude;
  userLng = pos.coords.longitude;
  userMarker = L.marker([userLat, userLng], {icon: userIcon}).addTo(map);
  map.setView([userLat, userLng], 14); // centrer sur l‚Äôutilisateur
});

    let userMarker, routingControl;

   function afficherPharmacies() {
  const list = document.getElementById("list");
  list.innerHTML = "";
  const groupe = getGroupeDeGarde();
  const enGarde = groupes[groupe].map(n => n.toLowerCase());

  pharmacies.forEach((ph, index) => {
    const isGarde = enGarde.includes(ph.name.toLowerCase());
    const marker = L.marker(ph.coords, {icon: isGarde ? gardeIcon : nonGardeIcon}).addTo(map);
    marker.bindPopup(`
      <b>${ph.name}</b><br>
      üìç ${ph.address}<br>
      üìû ${ph.phone}<br>
      ${isGarde ? "‚úÖ De garde (Groupe " + groupe + ")" : "‚ùå Non de garde"}
    `);

 // üëâ Clic sur le marker = afficher itin√©raire
  marker.on("click", () => showRoute(index));

    const div = document.createElement("div");
    div.className = "pharmacy";
    div.innerHTML = `
      <h3>${ph.name}</h3>
      <p>üìç ${ph.address}</p>
      <p>üìû ${ph.phone}</p>
      <p class="${isGarde ? "garde" : "nongarde"}">${isGarde ? "‚úÖ De garde" : "Non de garde"}</p>
      <button onclick="showRoute(${index})">Itin√©raire</button>
    `;
    list.appendChild(div);
  });
}

// --- Globals ---
let userMarker1 = null; 
let accuracyCircle = null;
let routingControl1 = null;
let hasCentered = false;
let lastRouteUpdateTs = 0;
window.userLocation = null;
window.currentPharmacyIndex = undefined;

// --- Start GPS watch without constant recentering ---
map.locate({ watch: true, enableHighAccuracy: true, maxZoom: 20 });

map.on('locationfound', function(e) {
  const latlng = e.latlng;
  window.userLocation = latlng;

  // Center only once (first fix)
  if (!hasCentered) {
    map.setView(latlng, 16);
    hasCentered = true;
  }

  // Update or create user marker
  if (userMarker) {
    userMarker.setLatLng(latlng);
  } else {
    userMarker = L.marker(latlng, { icon: userIcon })
      .addTo(map)
      .bindPopup("üìç Vous √™tes ici");
  }

  // Accuracy circle
  if (accuracyCircle) {
    accuracyCircle.setLatLng(latlng);
    accuracyCircle.setRadius(e.accuracy || 25);
  } else {
    accuracyCircle = L.circle(latlng, {
      radius: e.accuracy || 25,
      color: '#3ea0ff',
      fillColor: '#3ea0ff',
      fillOpacity: 0.2,
      opacity: 0.5
    }).addTo(map);
  }

  // Debounced route refresh if a pharmacy is selected
  if (window.currentPharmacyIndex !== undefined) {
    const now = Date.now();
    if (now - lastRouteUpdateTs > 1200) { // 1.2s debounce
      showRoute(window.currentPharmacyIndex, { refresh: true });
      lastRouteUpdateTs = now;
    }
  }
});

map.on('locationerror', function(err) {
  console.error('GPS error:', err);
});

// --- Helper: validate coords [lat, lng] ---
function isValidCoords(c) {
  return Array.isArray(c) &&
    typeof c[0] === 'number' && typeof c[1] === 'number' &&
    Math.abs(c[0]) <= 90 && Math.abs(c[1]) <= 180;
}

// --- Show route to pharmacy ---
function showRoute(index, { refresh } = { refresh: false }) {
  if (!window.userLocation) {
    alert("Position utilisateur non trouv√©e.");
    return;
  }
  const ph = pharmacies[index];
  if (!ph || !isValidCoords(ph.coords)) {
    console.error('Coordonn√©es pharmacie invalides:', ph?.coords);
    alert("Coordonn√©es de la pharmacie invalides.");
    return;
  }

  window.currentPharmacyIndex = index;

  // Create routing control once; update waypoints on refresh
  if (!routingControl) {
    routingControl = L.Routing.control({
      waypoints: [
        L.latLng(window.userLocation),
        L.latLng(ph.coords)
      ],
      router: L.Routing.osrmv1(),
      lineOptions: {
        styles: [
          { color: 'deepskyblue', opacity: 0.9, weight: 8 },
          { color: 'blue', opacity: 0.6, weight: 4, dashArray: '10,6' }
        ]
      },
      createMarker: () => null,
      addWaypoints: false,
      draggableWaypoints: false,
      fitSelectedRoutes: true,
      show: false
    }).addTo(map);
  } else {
    // Update waypoints instead of recreating the control
    routingControl.setWaypoints([
      L.latLng(window.userLocation),
      L.latLng(ph.coords)
    ]);
  }
}

// --- After listing pharmacies, call showRoute(index) on click/select ---
afficherPharmacies();

  </script>
</body>

</html>
